<!DOCTYPE html>
<html lang="vi">
<header>
  <meta charset="utf-8" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <title>IR system</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
</header>

<body onload="on_load();">
  <style>
    * {
      margin: 0
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .custom-btn {
      color: #fff;
      border-radius: 6px;
      background: transparent;
      cursor: pointer;
      transition: .3s;
      position: relative;
      display: inline-block;
      box-shadow: inset 2px 2px 2px 0 rgba(255, 255, 255, .5), 7px 7px 20px 0 rgba(0, 0, 0, .1), 4px 4px 5px 0 rgba(0, 0, 0, .1);
      outline: none
    }

    .btn-13 {
      background-image: linear-gradient(315deg, #89d8d3 0%, #03c8a8 74%);
      border: none;
      z-index: 1
    }

    .btn-13:after {
      position: absolute;
      content: "";
      width: 100%;
      height: 0;
      bottom: 0;
      left: 0;
      z-index: -1;
      border-radius: 6px;
      background-image: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
      box-shadow: -7px -7px 20px 0 #fff9, -4px -4px 5px 0 #fff9, 7px 7px 20px 0 #0002, 4px 4px 5px 0 #0001;
      transition: .3s
    }

    .btn-13:hover:after {
      top: 0;
      height: 100%
    }

    .btn-13:active {
      top: 2px
    }

    .container {
      width: 100%;
      min-height: 100vh;
      background: #e0e5ec
    }

    /* ===== SEARCH & FILTER BAR ===== */
    .search_container {
      width: 100%;
      padding-bottom: 16px;
      border-bottom: 5px solid #4dccc6;
      background: #f5f7fb
    }

    .search_grid {
      display: grid;
      column-gap: 30px;
      grid-template-columns: repeat(3, minmax(160px, 1fr)) 240px 170px 170px 140px 140px 130px;
      align-items: center;
    }

    .search_grid .lbl {
      font-size: 14px;
      font-weight: bold;
      color: #475569
    }

    .search_grid input[type="text"],
    .search_grid select {
      width: 100%;
      height: 40px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      padding: 0 10px;
      font-size: 14px;
      background: #fff
    }

    /* === Object filters (dynamic rows) === */
    .objfilters {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .obj-row {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .obj-row input[type="text"] {
      width: 200px;
      height: 40px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      padding: 0 10px;
      font-size: 14px;
      background: #fff
    }

    .obj-row select {
      width: 70px;
      height: 40px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      padding: 0 10px;
      font-size: 14px;
      background: #fff
    }

    .obj-row input[type="number"] {
      width: 50px;
      height: 40px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      padding: 0 10px;
      font-size: 14px;
      background: #fff
    }

    .obj-row .del {
      background-image: linear-gradient(315deg, #ef4444 0%, #b91c1c 74%);
      border: none;
      height: 40px;
      border-radius: 8px;
      color: #fff;
      padding: 0 12px
    }

    .search_grid select[multiple] {
      height: 80px;
      padding: 6px
    }

    .group_btn {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end
    }

    .group_btn button {
      height: 40px;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      padding: 0 16px
    }

    /* ===== IMAGE GRID ===== */
    #div_img {
      display: flex;
      flex-wrap: wrap;
      padding: 20px;
      background: #e0e5ec;
      gap: 16px
    }

    .container_img_btn {
      position: relative;
      width: calc(25% - 12px);
      min-width: 260px;
      max-width: 318px;
      aspect-ratio: 16/9;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .08)
    }

    .container_img_btn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block
    }

    .container_img_btn img:hover {
      outline: 4px solid #4dccc6
    }

    /* overlay actions on hover */
    .actions {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 10px;
      background: rgba(0, 0, 0, .45);
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease-in-out
    }

    .container_img_btn:hover .actions {
      opacity: 1;
      pointer-events: auto
    }

    .btnrow {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center
    }

    .icon-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 0;
      background: #fff;
      display: grid;
      place-items: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .25);
      cursor: pointer;
      position: relative
    }

    .icon-btn .fa {
      font-size: 20px;
      color: #111
    }

    .icon-btn.like.active {
      outline: 3px solid #22c55e
    }

    .icon-btn.dislike.active {
      outline: 3px solid #ef4444
    }

    .tooltip {
      position: absolute;
      bottom: -26px;
      left: 50%;
      transform: translateX(-50%);
      background: #111;
      color: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: .9
    }

    .filename-badge {
      position: absolute;
      left: 8px;
      top: 8px;
      color: #fff;
      font-size: 12px;
      background: rgba(0, 0, 0, .55);
      padding: 3px 8px;
      border-radius: 999px;
      max-width: 90%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }

    .modal .filename-badge {
      top: 10px;
      left: 10px;
      right: auto;
      background: rgba(0, 0, 0, .65);
      font-weight: 600;
    }

    @media (pointer:coarse) {
      .actions {
        opacity: 0
      }

      .container_img_btn.show .actions {
        opacity: 1;
        pointer-events: auto
      }
    }

    /* ===== PAGING ===== */
    #div_page {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px 20px
    }

    .page_num a {
      color: #333;
      text-decoration: none;
      font-weight: 600
    }

    .page_num a.active {
      color: #0a8
    }

    #div_total_page {
      padding: 0 20px 10px;
      color: #333
    }

    /* ===== MODAL (Neighbors + Video) ===== */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.open {
      display: flex
    }

    .modal-card {
      width: min(1100px, 94vw);
      max-height: 90vh;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      display: grid;
      grid-template-rows: 52px auto 110px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .4)
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0
    }

    .modal-header h3 {
      font-size: 16px;
      margin: 0
    }

    .modal-body {
      padding: 10px;
      overflow: auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px
    }

    .video-wrap,
    .preview-wrap {
      background: #0b1220;
      border-radius: 8px;
      display: flex;
      /* flex để canh giữa */
      align-items: center;
      justify-content: center;
      min-height: 260px;
      max-height: 70vh;
      /* cao tối đa theo viewport */
    }

    .preview-wrap img {
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      /* không crop */
      display: block;
    }

    .thumb-strip {
      display: flex;
      gap: 8px;
      overflow: auto;
      padding: 8px;
      background: #f1f5f9;
      border-top: 1px solid #e2e8f0
    }

    .thumb {
      width: 160px;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent
    }

    .thumb.active {
      border-color: #10b981
    }

    .close-x {
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 6px;
      background: #e2e8f0
    }
  </style>

  <div class="container">
    <div class="search_container">
      <div class="search_grid">
        <div>
          <div class="lbl">Previous query</div>
          <input id="prev_query" type="text" placeholder="Ví dụ: người đàn ông đứng nói..." />
        </div>
        <div>
          <div class="lbl">Query</div>
          <input id="text_query" type="text" placeholder="Text query" />
        </div>
        <div>
          <div class="lbl">Next query</div>
          <input id="next_query" type="text" placeholder="Ví dụ: cảnh phòng thí nghiệm..." />
        </div>
        <div>
          <div class="lbl">OCR contains</div>
          <input id="ocr" type="text" placeholder="Văn bản trong ảnh..." />
        </div>
        <div>
          <div class="lbl">ASR</div>
          <input id="asr" type="text" placeholder="Caption ..." />
        </div>
        <div>
          <div class="lbl">Include IDs</div>
          <input id="include_ids" type="text" placeholder="Ví dụ: 30/100, 20 (L30/V100, L20)" style="width: 230px;"/>
        </div>


        <div class="group_btn" style="grid-column: -3 / -1; justify-content:flex-end;">
          <button class="custom-btn btn-13" id="btn-search"><span>Tìm kiếm</span></button>
          <button class="custom-btn btn-13" id="btn-reset"
            style="background-image:linear-gradient(315deg,#c084fc 0%,#7c3aed 74%)"><span>Reset</span></button>
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="lbl">Object filters</div>
          <div id="obj_filters" class="objfilters"></div>
          <button type="button" class="custom-btn btn-13" id="btn-add-filter" style="margin-top:8px;">+ Thêm điều
            kiện</button>
          <!-- suggestions populated from /api/objects -->
          <datalist id="objlist"></datalist>
        </div>


      </div>
    </div>

    <div id="div_img"></div>

    <div style="height:5px;width:100%;background-color:black;"></div>
    <div id="div_page"></div>
    <div id="div_total_page">Total: 0 page</div>
    <div style="margin-bottom:50px;"></div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="modal-title">Frames around</h3>
        <div class="close-x" id="modal-close">Đóng ✕</div>
      </div>
      <div class="modal-body">
        <div class="preview-wrap" id="preview">
          <!-- ảnh lớn sẽ hiển thị ở đây -->
        </div>
      </div>
      <div class="thumb-strip" id="thumb-strip"></div>
    </div>
  </div>

  <script>
    // ======= Setup & helpers =======
    var data = '{{ data|tojson }}';
    data = data.replace(/\s/g, '').replace(/\\/g, '/');
    data = JSON.parse(data);

    const urlParams = new URLSearchParams(window.location.search);
    const textquery = urlParams.get('query');
    if (textquery) document.getElementById('text_query').value = decodeURIComponent(textquery);
    const prev_query = urlParams.get('prev');
    if (prev_query) document.getElementById('prev_query').value = decodeURIComponent(prev_query);
    const nextquery = urlParams.get('next');
    if (nextquery) document.getElementById('next_query').value = decodeURIComponent(nextquery);
    const ocr = urlParams.get('ocr');
    if (ocr) document.getElementById('ocr').value = decodeURIComponent(ocr);

    const ratings = new Map(); // id -> 'pos' | 'neg'
    function nameFromPath(p) {
      const parts = (p || '').split(/[\\/]/).filter(Boolean);
      return parts.slice(-2).join('/'); // ví dụ: L30_V083/051.jpg
    }
    // ======= Populate object classes =======
    async function loadObjects() {
      try {
        const r = await fetch("{{ url_for('get_objects_list') }}");
        const j = await r.json();
        const classes = j.classes || [];
        const dl = document.getElementById('objlist');
        dl.innerHTML = classes.map(c => `<option value="${c}">`).join('');
        window.__OBJECT_CLASSES__ = classes;
      } catch (err) {
        console.warn('Load objects failed, fallback demo');
        const fallback = ['person', 'mask', 'car', 'mic', 'book', 'screen'];
        document.getElementById('objlist').innerHTML = fallback.map(c => `<option value="${c}">`).join('');
        window.__OBJECT_CLASSES__ = fallback;
      }
    }
    // ======= Object filters: dynamic rows =======
    function addObjRow(initial = { name: '', cmp: 'eq', count: '' }) {
      const wrap = document.getElementById('obj_filters');
      const row = document.createElement('div');
      row.className = 'obj-row';
      row.innerHTML = `
    <input type="text" class="obj-name" list="objlist" placeholder="object (vd: person)" value="${initial.name || ''}">
    <select class="obj-cmp">
      <option value="eq"  ${initial.cmp === 'eq' ? 'selected' : ''}>=</option>
      <option value="gte" ${initial.cmp === 'gte' ? 'selected' : ''}>&ge;</option>
      <option value="gt"  ${initial.cmp === 'gt' ? 'selected' : ''}>&gt;</option>
      <option value="lte" ${initial.cmp === 'lte' ? 'selected' : ''}>&le;</option>
      <option value="lt"  ${initial.cmp === 'lt' ? 'selected' : ''}>&lt;</option>
    </select>
    <input type="number" class="obj-count" min="0" step="1" placeholder="n" value="${(initial.count ?? '')}">
    <button type="button" class="custom-btn btn-13 del" title="Xoá">−</button>
  `;
      wrap.appendChild(row);
    }

    function readObjFilters() {
      const rows = Array.from(document.querySelectorAll('#obj_filters .obj-row'));
      const filters = [];
      rows.forEach(r => {
        const name = r.querySelector('.obj-name').value.trim();
        const cmp = r.querySelector('.obj-cmp').value;
        const cntS = r.querySelector('.obj-count').value;
        if (name && cntS !== '') {
          const count = Math.max(0, parseInt(cntS, 10) || 0);
          filters.push({ name, cmp, count });
        }
      });
      return filters;
    }

    // Add/remove row events
    document.addEventListener('click', (e) => {
      if (e.target.id === 'btn-add-filter') {
        addObjRow();
      } else if (e.target.closest && e.target.closest('#obj_filters .del')) {
        const row = e.target.closest('.obj-row');
        if (row) row.remove();
      }
    });

    // ======= Paging =======
    function add_paging() {
      const curUrl = new URL(window.location.href);
      let cur_index = parseInt(curUrl.searchParams.get("page"));
      if (Number.isNaN(cur_index)) cur_index = 1;

      const total = Number(data['total_page'] || 0);
      const container = document.getElementById("div_page");
      container.innerHTML = "";
      if (total <= 0) {
        document.getElementById("div_total_page").innerText = "Total: 0 page";
        return;
      }

      const WINDOW = 4;                                  // số trang trước/sau
      const start = Math.max(1, cur_index - WINDOW);
      const end = Math.min(total, cur_index + WINDOW);

      if (start > 1) container.appendChild(mkDots());

      for (let i = start; i <= end; i++) {
        const a = document.createElement('a');

        // GIỮ NGUYÊN TOÀN BỘ THAM SỐ HIỆN TẠI (textsearch/imgsearch/filters/...)
        const params = new URLSearchParams(curUrl.searchParams);
        params.set('page', i);                          // chỉ thay index (0-based)
        params.set('size', 100);

        // giữ nguyên đường dẫn hiện tại (/textsearch hoặc /imgsearch) và hash nếu có
        a.href = `${curUrl.pathname}?${params.toString()}${curUrl.hash || ''}`;
        a.textContent = String(i);                   // hiển thị 1-based
        if (i === cur_index) a.classList.add('active');

        const wrap = document.createElement('div');
        wrap.className = 'page_num';
        wrap.appendChild(a);
        container.appendChild(wrap);
      }

      if (end < total) container.appendChild(mkDots());

      document.getElementById("div_total_page").innerText = "Total: " + total + " page";

      function mkDots() {
        const d = document.createElement('div');
        d.className = 'page_num';
        d.innerHTML = '...';
        return d;
      }
    }

    // ======= Render images =======
    function add_img() {
      const grid = $("#div_img");
      grid.empty();

      const pagefile_list = data['results'] || [];
      pagefile_list.forEach((item) => {
        const id = item.id;
        // const fname = item.filename || item.imgpath?.split('/').pop() || id;
        const parts = (item.path || '').split(/[\\/]/).filter(Boolean); // tách theo / hoặc \
        const fname = parts.slice(-2).join('/') || String(id);
        grid.append(`
          <div class="container_img_btn" data-id="${id}" data-fname="${fname}">
            <img alt="${fname}" src="get_img?fpath=${encodeURIComponent(item.path)}" loading="lazy">
            <div class="actions">
              <div class="btnrow">
                <button class="icon-btn" data-action="ir" title="Image Search"><i class="fa fa-search"></i><span class="tooltip">IR</span></button>
                <button class="icon-btn like" data-action="pos" data-toggle title="Positive"><i class="fa fa-thumbs-up"></i></button>
                <button class="icon-btn dislike" data-action="neg" data-toggle title="Negative"><i class="fa fa-thumbs-down"></i></button>
                <button class="icon-btn" data-action="neighbors" title="Neighbors"><i class="fa fa-image"></i></button>
              </div>
            </div>
            <span class="filename-badge">${fname}</span>
          </div>
        `);
      });
    }

    // ======= Event delegation =======
    // Mobile: tap card to toggle overlay
    $('#div_img').on('click', '.container_img_btn', function (e) {
      if (window.matchMedia('(pointer:coarse)').matches) {
        if (!e.target.closest('.icon-btn')) {
          $(this).toggleClass('show');
        }
      }
    });

    // Click action icons
    $('#div_img').on('click', '.icon-btn', async function (e) {
      e.stopPropagation();
      const $card = $(this).closest('.container_img_btn');
      const id = $card.data('id');
      const action = $(this).data('action');
      const imageSearchUrl = "{{ url_for('image_search') }}"

      if (action === 'ir') {
        window.open(`${imageSearchUrl}?imgid=${id}`, '_blank');
        return;
      }

      if (action === 'pos' || action === 'neg') {
        ratings.set(id, action);
        $card.find('[data-toggle]').removeClass('active');
        $(this).addClass('active');
        // auto submit (tuỳ chọn): uncomment nếu muốn gửi ngay
        // submitFeedback(id, action);
        return;
      }

      if (action === 'neighbors') {
        openNeighborsModal(id, $card.data('fname'));
        return;
      }

      if (action === 'play') {
        openVideoModal(id, $card.data('fname'));
        return;
      }
    });

    async function submitFeedback(id, label) {
      try {
        const res = await fetch('/feedback', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, label })
        });
        if (!res.ok) throw new Error(await res.text());
      } catch (err) { console.error(err); alert('Gửi feedback thất bại!'); }
    }

    // ======= Search build =======
    function getSelectedValues(selectEl) {
      return Array.from(selectEl.selectedOptions).map(o => o.value);
    }

    function buildSearchURL() {
      const prev = document.getElementById('prev_query').value || '';
      const query = document.getElementById('text_query').value || '';
      const next = document.getElementById('next_query').value || '';
      const ocr = document.getElementById('ocr').value || '';
      const filters = readObjFilters(); // [{name,cmp,count}, ...]

      const params = new URLSearchParams();
      if (prev) params.set('prev', prev);
      if (query) params.set('query', query);
      if (next) params.set('next', next);
      if (ocr) params.set('ocr', ocr);
      if (filters.length) {
        // serialize as: name:cmp:count,name:cmp:count  (vd: person:gte:2,car:eq:1)
        const packed = filters.map(f => `${f.name}:${f.cmp}:${f.count}`).join(',');
        params.set('obj_filters', packed);
      }
      const url = "{{ url_for('text_search') }}?"
      return url + params.toString();
    }

    document.getElementById('btn-search').addEventListener('click', () => {
      window.location.href = buildSearchURL();
    });
    document.getElementById('btn-reset').addEventListener('click', () => {
      ['prev_query', 'text_query', 'next_query', 'ocr'].forEach(id => document.getElementById(id).value = '');
      const wrap = document.getElementById('obj_filters');
      wrap.innerHTML = '';
      addObjRow(); // để lại 1 hàng trống
    });
    ['prev_query', 'text_query', 'next_query', 'ocr'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { window.location.href = buildSearchURL(); }
      });
    });

    // ======= Modal logic =======
    const modal = document.getElementById('modal');
    const strip = document.getElementById('thumb-strip');
    const preview = document.getElementById('preview');
    const modalTitle = document.getElementById('modal-title');

    // State for neighbors navigation
    let neiFrames = [];   // [{imgpath, id?}, ...]
    let neiIndex  = -1;   // current index in neiFrames

    document.getElementById('modal-close').addEventListener('click', closeModal);

    function onKeydownModal(e){
      if (!modal.classList.contains('open')) return;
      if (e.key === 'Escape') { closeModal(); return; }
      if (e.key === 'ArrowLeft')  { navigateNeighbors(-1); }
      if (e.key === 'ArrowRight') { navigateNeighbors(+1); }
    }
    document.addEventListener('keydown', onKeydownModal);

    function openModal(title) {
      modalTitle.textContent = title;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      strip.innerHTML = ''; preview.innerHTML = '';
      // reset neighbors state
      neiFrames = []; neiIndex = -1;
      strip.onclick = null;
    }

    async function openNeighborsModal(id, fname) {
      openModal(`Frames around: ${fname}`);
      // Load neighbors
      try {
        const k = 10
        const apiUrl = "{{ url_for('get_neighbors') }}";
        const r = await fetch(`${apiUrl}?imgid=${id}&k=${k}`);
        const j = await r.json();
        const frames = j.frames || [];
        if (frames.length) {
          // cache frames & initial index
          neiFrames = frames.slice();
          neiIndex  = Math.floor(frames.length / 2);

          // initial preview
          setPreviewByIndex(neiIndex);

          // build thumbnails
          strip.innerHTML = neiFrames.map((f, i) => `
            <img class="thumb ${i === neiIndex ? 'active' : ''}"
              data-src="${f.imgpath}" data-name="${nameFromPath(f.imgpath)}"
              src="get_img?fpath=${f.imgpath}">
          `).join('');
          // attach click once (delegated), persistent
          strip.onclick = onThumbClick;
        }
      } catch (err) { console.error(err); }
    }

    function onThumbClick(e) {
      const t = e.target.closest('.thumb');
      if (!t) return;
      const thumbs = Array.from(strip.querySelectorAll('.thumb'));
      const idx = thumbs.indexOf(t);
      if (idx < 0) return;
      neiIndex = idx;
      setPreviewByIndex(neiIndex);
    }

    function navigateNeighbors(delta){
      if (!neiFrames.length) return;
      const next = Math.min(neiFrames.length - 1, Math.max(0, neiIndex + delta));
      if (next === neiIndex) return;
      neiIndex = next;
      setPreviewByIndex(neiIndex);
    }

    function setPreviewByIndex(idx){
      const f = neiFrames[idx];
      if (!f) return;
      setPreview(f.imgpath, nameFromPath(f.imgpath));
      // update thumb active class
      const thumbs = Array.from(strip.querySelectorAll('.thumb'));
      thumbs.forEach((el, i) => el.classList.toggle('active', i === idx));
      // ensure visible
      const el = thumbs[idx];
      if (el && el.scrollIntoView) el.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
    }
    function setPreview(imgpath, name) {
      const fname = name || nameFromPath(imgpath);
      preview.innerHTML = `
    <div style="position:relative; width:100%; display:flex; align-items:center; justify-content:center;">
      <img src="get_img?fpath=${imgpath}" alt="${fname}">
      <span class="filename-badge">${fname}</span>
    </div>
  `;
    }

    // ======= Init =======
    function on_load() {
      // nếu backend trả thêm query_prev/next thì fill
      if ("query" in data) document.getElementById("text_query").value = decodeURIComponent(data["query"]);
      if ("query_prev" in data) document.getElementById("prev_query").value = decodeURIComponent(data["query_prev"]);
      if ("query_next" in data) document.getElementById("next_query").value = decodeURIComponent(data["query_next"]);

      loadObjects();
      // Prefill object filters from URL (?obj_filters=person:gte:2,car:eq:1)
      const pf = urlParams.get('obj_filters');
      const wrap = document.getElementById('obj_filters');
      wrap.innerHTML = '';
      if (pf) {
        pf.split(',').forEach(tok => {
          const [name, cmp, count] = tok.split(':');
          addObjRow({ name: name || '', cmp: cmp || 'eq', count: count || '' });
        });
      } else {
        addObjRow(); // one empty row by default
      }
      add_paging();
      add_img();
    }
    window.on_load = on_load;
  </script>
</body>

</html>